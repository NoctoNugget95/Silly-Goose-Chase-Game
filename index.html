<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Silly Goose Chase</title>
    
    <!-- Google Fonts: Barriecito -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barriecito&display=swap" rel="stylesheet">

   <style>
       /* 1. THE PAGE SETUP (The Flex Container) */
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* No scrollbars on the main page */
            background-color: #202020; 
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            
            /* THIS CENTERS THE GAME */
            display: flex;
            justify-content: center;
            align-items: center;
            
            touch-action: none; 
            -webkit-user-select: none;
            user-select: none;
        }

        /* 2. THE GAME BOX (The Centerpiece) */
        #game-stage {
            position: relative;
            width: 1280px;  /* Fixed Desktop Width */
            height: 720px; /* Fixed Desktop Height */
            /* Safety: Ensure it never overflows small screens */
            max-width: 100vw;
            max-height: 100vh;
            /* -------------------------------- */
            
            /* Background & Border */
            background-color: #f0f0f0;
            background-image: 
                linear-gradient(#e0e0e0 1px, transparent 1px),
                linear-gradient(90deg, #e0e0e0 1px, transparent 1px);
            background-size: 40px 40px;
            
            border: 4px solid #333; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5); /* Nice shadow */
            overflow: hidden; 
        }

        /* 3. MOBILE OVERRIDE (Fills screen only on phones) */
        @media (max-width: 1024px) {
            #game-stage {
                width: 100vw;
                height: 100vh;
                border: none;
                box-shadow: none;
            }
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        /* Main Title Styling */
        #main-title {
            position: absolute;
            top: 6%; /* Moved down slightly */
            width: 100%;
            text-align: center;
            font-family: 'Barriecito', cursive;
            font-size: 5rem; /* Bigger title */
            color: #d32f2f;
            text-shadow: 4px 4px 0px #000;
            margin: 0;
            z-index: 30;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        
        .hidden { display: none !important; }

        /* BIGGER START BOX */
        .message-box {
            display: none; 
            pointer-events: auto; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 25px;
            
            background: #ffffff;
            border: 6px solid #000;
            border-radius: 30px;
            padding: 40px; /* More breathing room */
            text-align: center;
            box-shadow: 15px 15px 0px rgba(0,0,0,0.2);
            
            /* Bigger Dimensions */
            min-width: 300px; 
            
            font-size: 2rem; /* Bigger Text */
            font-family: 'Barriecito', cursive;
            z-index: 20;
            margin-top: 50px; /* Push it down a bit so it doesn't hit title */
        }
        
        .message-box.active { display: flex !important; }

        /* BUTTON STYLING */
        button {
            background: #ffeb3b;
            border: 4px solid #000;
            padding: 15px 40px; /* Bigger button */
            font-size: 1.8rem; /* Bigger text */
            font-family: inherit;
            cursor: pointer;
            border-radius: 12px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }

        /* CHARACTER POSITIONING (Fixed to the Box) */
        #start-rev-img {
            position: absolute;
            right: -10%; /* Tucked into the corner */
            bottom: -15%;
            height: 90%; /* Scale relative to the box height */
            width: auto;
            scale: 1.1;
            object-fit: contain;
            pointer-events: none;
            z-index: 1; 
        }
        
        #start-goose-img {
            position: absolute;
            left: -5%;
            bottom: 0%;
            height: 60%; 
            width: auto;
            object-fit: contain;
            pointer-events: none;
            z-index: 1; 
        }

        /* ... Keep your existing @keyframes spinIn, #loading, etc. ... */
        
        /* Secret Level Override */
        #game-stage.blueprint-mode {
            background-color: #0d47a1;
        }
        
       /* Audio Controls - Snappier Hover */
        #audio-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            height: 40px;
            background: rgba(255,255,255,0.8);
            border: 2px solid #333;
            border-radius: 20px;
            display: flex;
            align-items: center;
            pointer-events: auto;
            z-index: 1001;
            
            /* The Animation Settings */
            width: 40px; /* Default Collapsed */
            overflow: hidden; /* Cut off the slider when closed */
            transition: width 0.2s ease-out; /* Faster snap (0.2s) */
        }
        
        #audio-controls:hover {
            width: 160px; /* Expanded */
        }

        #mute-btn {
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            user-select: none;
        }

        #volume-slider {
            width: 100px;
            margin-left: 5px;
            margin-right: 10px;
            cursor: pointer;
            
            /* Hide logic */
            opacity: 0;
            pointer-events: none; /* Can't touch it when hidden */
            transition: opacity 0.1s ease-in; /* Fade out fast */
        }

        /* Show slider ONLY when hovering the container */
        #audio-controls:hover #volume-slider {
            opacity: 1;
            pointer-events: auto;
            transition: opacity 0.3s ease-out 0.1s; /* Slight delay appearing */
        }}
        
        #score-display {
            position: absolute;
            top: 25px;
            right: 30px;
            font-size: 2rem; /* Nice and big */
            font-family: 'Barriecito', cursive; /* Matches your Title font */
            color: #333;
            text-shadow: 2px 2px 0px #fff; /* White outline for readability */
            z-index: 50; /* Sits above the game, but below Pause/Start screens */
            pointer-events: none; /* Lets you click "through" it if needed */
            user-select: none;
        }

       /* --- ROTATE MESSAGE STYLES --- */
        #rotate-message {
            display: none !important; /* Hidden by default on Desktop/Laptop */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #202020; /* Dark background to match the page */
            color: #fff;
            z-index: 9999; /* Sit on top of EVERYTHING */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        /* SHOW ONLY ON MOBILE PORTRAIT */
        @media only screen and (orientation: portrait) and (max-width: 768px) {
            #rotate-message { display: flex !important; } /* Force show */
            #game-stage { display: none !important; } /* Hide the game box */
        }

       /* PAUSE SCREEN STYLES */
        #pause-overlay {
            display: none; /* Hidden by default */
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            
            /* Darken background slightly so text pops */
            background: rgba(0, 0, 0, 0.4); 
            
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 900; /* On top of everything */
            pointer-events: auto; /* Catch clicks */
            backdrop-filter: blur(2px); /* Optional: slight blur effect */
        }
        
        #pause-overlay.active { display: flex !important; }
        
        .pause-title {
            font-family: 'Barriecito', cursive;
            font-size: 6rem;
            color: #fff;
            text-shadow: 4px 4px 0px #000;
            margin: 0;
            letter-spacing: 5px;
        }
        
        .pause-subtitle {
            font-family: 'Comic Sans MS', sans-serif;
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 2px 2px 0px #000;
            margin-top: 10px;
        }
        
        /* Auto-Switch Text based on device type */
        .desktop-hint { display: block; }
        .mobile-hint { display: none; }
        
        @media (hover: none) and (pointer: coarse) {
            .desktop-hint { display: none; }
            .mobile-hint { display: block; }
        }
       
    </style>

     <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
</head>
<body>

<div id="rotate-message">
    <div style="font-size: 50px; margin-bottom: 20px;">üîÑ</div>
    <h1>Please Rotate Device</h1>
    <p>This game is best played in Landscape mode!</p>
</div>

<div id="game-stage">

    <canvas id="gameCanvas"></canvas>
    
    <div id="score-display">Score: 0</div>

    <div id="audio-controls">
        <div id="mute-btn">üîä</div>
        <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.5">
    </div>

    <div id="ui-layer">
        <h1 id="main-title">Silly Goose Chase</h1>

        <div id="start-screen" class="message-box active">
            <h1 style="font-size: 3rem; margin: 0 0 10px 0; color: #d32f2f;">Silly Goose</h1>
            
            <div style="margin-bottom: 10px; font-size: 1.2rem; color: #555;">
                Playing as: <strong id="current-username-display" style="color:#000;">Guest</strong>
                <a href="#" onclick="changeUser()" style="font-size: 0.9rem; color: #555; text-decoration: underline; margin-left: 5px;">(Switch)</a>
            </div>

            <button id="start-btn" onclick="startGame()">Start Flying</button>

            <div id="leaderboard-container" style="margin-top: 20px; width: 100%;">
                <h3 style="margin: 0 0 5px 0; font-size: 1.5rem; text-decoration: underline;">Global Top 5</h3>
                <div id="leaderboard-list" style="font-size: 1.2rem; text-align: left; background: #eee; padding: 10px; border: 2px solid #333; border-radius: 10px; min-height: 100px;">
                    Loading scores...
                </div>
            </div>
        </div>
        
        <img id="start-rev-img" alt="Rev" style="display:block;">
        <img id="start-goose-img" alt="Goose" style="display:block;">
        
        <div id="game-over-screen" class="message-box">
            <h1>Silly Goose!</h1>
            <p>Your Score: <span id="final-score">0</span></p>
            <p style="font-size: 1.5rem; color: #d32f2f;">Your Best: <span id="best-score-display">0</span></p>
            <button id="restart-btn">Try Again</button>
        </div>

        <div id="pause-overlay">
            <h1 class="pause-title">PAUSED</h1>
            <p class="pause-subtitle desktop-hint">Click Anywhere or Press Spacebar to Resume</p>
            <p class="pause-subtitle mobile-hint">Tap Anywhere to Resume</p>
        </div>
    </div>
    
    <div id="loading">Loading...</div>
</div>

<script>
    window.addEventListener('load', function() {
        setTimeout(function() {
            var loader = document.getElementById('loading');
            if (loader) loader.style.display = 'none';
        }, 500);
    });
    
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        var loader = document.getElementById('loading');
        if(loader) {
            loader.className = 'error';
            loader.innerHTML = "<strong>‚ö†Ô∏è Game Crashed!</strong><br><br>" + msg + "<br><br>Check Line: " + lineNo;
            loader.style.display = 'flex';
        }
        return false;
    };
</script>

<script>
    // ==========================================
    // --- PART A: FIREBASE & LEADERBOARD ---
    // ==========================================
    
    let db = null;
    let currentUser = localStorage.getItem('sillyGooseUsername') || "Guest";
    // Local Personal Best (to avoid spamming DB)
    let highScore = parseInt(localStorage.getItem('sillyGooseHighScore')) || 0;

    // 1. Initialize Database
    try {
        // I HAVE FILLED THESE IN FOR YOU FROM YOUR SCREENSHOT
        const firebaseConfig = {
            apiKey: "AIzaSyA4eP_ypqzLq1KvKe8ffbdQJZTmh9iaKzM",
            authDomain: "silly-goose-chase.firebaseapp.com",
            projectId: "silly-goose-chase",
            storageBucket: "silly-goose-chase.firebasestorage.app",
            messagingSenderId: "178014526530",
            appId: "1:178014526530:web:bef279b366275b7b1761db"
        };

        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase connected.");
            fetchLeaderboard(); // Load the list immediately
        }
    } catch (err) {
        console.warn("Offline Mode:", err);
        const listDiv = document.getElementById('leaderboard-list');
        if(listDiv) listDiv.innerText = "Offline Mode (Check Console)";
    }

    // --- FUNCTION 1: Fetch Top 5 Scores ---
    function fetchLeaderboard() {
        if (!db) return;

        db.collection("leaderboard")
          .orderBy("score", "desc")
          .limit(5)
          .onSnapshot((snapshot) => {
              const listDiv = document.getElementById('leaderboard-list');
              if(!listDiv) return;
              
              let html = "";
              let rank = 1;
              
              snapshot.forEach((doc) => {
                  const data = doc.data();
                  let icon = rank === 1 ? "üëë" : (rank === 2 ? "ü•à" : (rank === 3 ? "ü•â" : `#${rank}`));
                  const isMe = data.name === currentUser ? "color:#d32f2f; font-weight:bold;" : "";
                  
                  html += `<div style="display:flex; justify-content:space-between; ${isMe}">
                              <span>${icon} ${data.name}</span>
                              <span>${data.score}</span>
                           </div>`;
                  rank++;
              });

              if (html === "") html = "No scores yet. Be the first!";
              listDiv.innerHTML = html;
          }, (error) => {
              console.log("Leaderboard Error:", error);
              if (error.message && error.message.includes("index")) {
                  console.log("‚ö†Ô∏è CLICK THE LINK ABOVE IN CONSOLE TO CREATE INDEX ‚ö†Ô∏è");
              }
          });
    }

    // --- FUNCTION 2: Save Score ---
    function trySaveScore(newScore) {
        // Always update local high score if beaten
        if (newScore > highScore) {
            highScore = newScore;
            localStorage.setItem('sillyGooseHighScore', highScore);
        }

        if (!db) return;

        // Save to cloud if it beats local best OR just to be safe
        if (newScore >= highScore) {
            if (currentUser === "Guest") {
                const name = prompt("New High Score! Enter name:");
                if (name) {
                    currentUser = name.trim();
                    localStorage.setItem('sillyGooseUsername', currentUser);
                    updateUserDisplay();
                }
            }

            db.collection("leaderboard").doc(currentUser).set({
                name: currentUser,
                score: newScore,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => console.log("Score saved to leaderboard!"))
            .catch((err) => console.error("Save failed", err));
        }
    }

    // --- FUNCTION 3: UI Utilities ---
    function updateUserDisplay() {
        const el = document.getElementById('current-username-display');
        if (el) el.innerText = currentUser;
        
        const bestEl = document.getElementById('best-score-display');
        if (bestEl) bestEl.innerText = highScore;
    }

    window.changeUser = function() {
        const newName = prompt("Enter username:", currentUser);
        if (newName) {
            currentUser = newName.trim();
            localStorage.setItem('sillyGooseUsername', currentUser);
            highScore = 0; // Reset local best so a new user can compete from 0
            localStorage.setItem('sillyGooseHighScore', 0);
            updateUserDisplay();
        }
    };

    // ==========================================
    // --- PART B: GAME ASSETS & CONSTANTS ---
    // ==========================================

    const PERMANENT_PLAYER_SVG = `sprite.png`; 
    const SECRET_PLAYER_SRC = `secret_player.png`;
    const START_SCREEN_GOOSE_SRC = `goose.png`; 
    const START_SCREEN_REV_SRC = `rev.png?v=2`; 

    const AUDIO_FILES = {
        jump: "jump.wav",
        coin1: "coin1.wav",
        coin2: "coin2.wav",
        powerup: "",
        music_main: "music_main.wav",
        music_clash: "music_clash.wav",
        music_start: "music.start.wav"
    };

    const CONFIG = {
        gravity: 0.2, 
        jumpStrength: -6.5,
        gameSpeed: 3.3, 
        spawnRate: 240, 
        gapSize: 220,   
        playerScale: 0.15,
        doodleWobbleSpeed: 0.1,
        clashDuration: 180,
        batterySpawnChance: 0.005, 
        coinChancePerGap: 0.25
    };

    // Globals
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let frames = 0;
    let score = 0;
    let startFreeze = 0;
    let isGameOver = false;
    let isPlaying = false;
    let isClashing = false;
    let clashTimer = 0;
    let doodleTime = 0;
    let isPaused = false;
    
    // Entities
    const secretMode = { active: false, timer: 0, maxDuration: 300 };
    const battery = { active: false, x: 0, y: 0, width: 30, height: 50, wobble: 0 };
    const player = { x: 0, y: 0, width: 50, height: 50, velocity: 0, rotation: 0, baseX: 0, baseY: 0 };
    const goose = { x: -100, y: 0, targetX: 50, frame: 0 };
    
    let obstacles = [];
    let particles = [];
    let clashCloudParticles = [];
    let bgElements = [];
    let coins = [];
    let scoreFloater = [];

    // --- ASSET LOADING ---
    const playerImg = new Image();
    playerImg.onerror = function() { playerImg.src = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MCA1MCI+PHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjMjliNmY2Ii8+PC9zdmc+"; };
    if (PERMANENT_PLAYER_SVG) playerImg.src = PERMANENT_PLAYER_SVG.trim();

    const secretPlayerImg = new Image();
    if (SECRET_PLAYER_SRC) secretPlayerImg.src = SECRET_PLAYER_SRC.trim();
    
    // UI Images
    const revImg = document.getElementById('start-rev-img');
    const gooseImg = document.getElementById('start-goose-img');
    if (START_SCREEN_REV_SRC && revImg) revImg.src = START_SCREEN_REV_SRC.trim();
    if (START_SCREEN_GOOSE_SRC && gooseImg) gooseImg.src = START_SCREEN_GOOSE_SRC.trim();

    // ==========================================
    // --- PART C: AUDIO SYSTEM ---
    // ==========================================
    const AudioSys = {
        ctx: null, isPlaying: false, isMuted: false, tempo: 1.45,
        masterVolume: 0.5, customBuffers: {}, activeSource: null, bgMusicGainNode: null,
        nextNoteTime: 0, noteIndex: 0, currentTrack: 'main',

        N: { G2: 98, A2: 110, C3: 130.81, E3: 164.81, G3: 196, A4: 440, Cs5: 554.37, E5: 659.25 },
        tracks: {
            main: [ {f: 'A4', d: 0.15}, {f: 'C5', d: 0.15}, {f: 'E5', d: 0.15}, {f: 0, d: 0.15} ], // Shortened for brevity
            clash: [ {f: 'C4', d: 0.1}, {f: 'Cs4', d: 0.1}, {f: 0, d: 0.1} ]
        },

        init: function() {
            if (!this.ctx) {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.loadCustomSounds();
            }
        },

        loadCustomSounds: function() {
            const loadBuffer = (key, path) => {
                if (!path) return;
                fetch(path).then(r => r.arrayBuffer()).then(b => this.ctx.decodeAudioData(b)).then(d => { this.customBuffers[key] = d; }).catch(e=>{});
            };
            for(let k in AUDIO_FILES) loadBuffer(k, AUDIO_FILES[k]);
            loadBuffer('main', AUDIO_FILES.music_main);
            loadBuffer('clash', AUDIO_FILES.music_clash);
            loadBuffer('music_start', AUDIO_FILES.music_start);
        },

        toggleMute: function() {
            this.isMuted = !this.isMuted;
            document.getElementById('mute-btn').innerText = this.isMuted ? "üîá" : "üîä";
            if(this.ctx) this.isMuted ? this.ctx.suspend() : this.ctx.resume();
        },
        
        setVolume: function(val) {
            this.masterVolume = parseFloat(val);
            if (this.masterVolume > 0 && this.isMuted) this.toggleMute();
            if (this.bgMusicGainNode) this.bgMusicGainNode.gain.setValueAtTime(0.1 * this.masterVolume, this.ctx.currentTime);
        },

        playTone: function(freq, duration, type = 'triangle', vol = 0.1) {
            if (this.isMuted || !this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type; osc.frequency.value = freq;
            gain.gain.setValueAtTime(vol * this.masterVolume, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.start(); osc.stop(this.ctx.currentTime + duration);
        },

        playTrack: function(trackName) {
            if (this.activeSource) { try { this.activeSource.stop(); } catch(e){} }
            this.currentTrack = trackName;
            this.isPlaying = true;
            
            let bufferKey = trackName;
            if(trackName === 'start_screen') bufferKey = 'music_start';

            if (!this.customBuffers[bufferKey]) return; // Wait for load

            const source = this.ctx.createBufferSource();
            source.buffer = this.customBuffers[bufferKey];
            source.loop = true;
            const gain = this.ctx.createGain();
            gain.gain.value = 0.1 * this.masterVolume;
            source.connect(gain); gain.connect(this.ctx.destination);
            source.start();
            this.activeSource = source;
            this.bgMusicGainNode = gain;
        },

        stopMusic: function() {
            this.isPlaying = false;
            if (this.activeSource) { try{this.activeSource.stop();}catch(e){}; this.activeSource=null; }
        },
        
        update: function() { /* Fallback synth logic removed for brevity, relies on files */ },

        playSound: function(name) {
            if (this.isMuted || !this.ctx) return;
            let key = name;
            if (name === 'coin') key = Math.random() > 0.5 ? 'coin1' : 'coin2';
            
            if (this.customBuffers[key]) {
                const src = this.ctx.createBufferSource();
                src.buffer = this.customBuffers[key];
                const g = this.ctx.createGain();
                g.gain.value = (key==='coin2'?3.0:0.6) * this.masterVolume;
                src.connect(g); g.connect(this.ctx.destination);
                src.start();
            } else {
                // Fallback beeps
                if(name==='jump') this.playTone(300, 0.1, 'triangle', 0.1);
                if(name==='coin') this.playTone(1200, 0.1, 'sine', 0.3);
            }
        }
    };

    // ==========================================
    // --- PART D: GAME LOOP & LOGIC ---
    // ==========================================

    function resize() {
        const stage = document.getElementById('game-stage');
        canvas.width = stage.clientWidth;
        canvas.height = stage.clientHeight;
        ctx.imageSmoothingEnabled = false;
        if (!isPlaying && !isClashing && player) {
            player.baseX = canvas.width * 0.30;
            player.x = player.baseX;
            player.y = canvas.height / 2;
        }
    }

    function createParticle(x, y, type) {
        particles.push({ x, y, vx: (Math.random()-0.5)*2, vy: (Math.random()-0.5)*2, life: 30, type, color: type==='spark'?"#4fc3f7":"rgba(0,0,0,0.2)" });
    }

    function createObstacle(overrideX) {
        let x = (typeof overrideX === 'number') ? overrideX : canvas.width;
        const minH = 50, maxH = canvas.height - CONFIG.gapSize - minH;
        const topH = Math.floor(Math.random() * (maxH - minH + 1) + minH);
        
        obstacles.push({ x: x, topHeight: topH, bottomY: topH + CONFIG.gapSize, width: 70, passed: false, colorIndex: Math.floor(Math.random()*3) });

        if (Math.random() < CONFIG.coinChancePerGap) {
            const coinX = x + (CONFIG.spawnRate * CONFIG.gameSpeed / 2) + 35;
            const coinY = topH + (CONFIG.gapSize/2) + (Math.random()-0.5)*100;
            coins.push({ x: coinX, y: coinY, value: 5, color: "#cd7f32", radius: 15, wobbleOffset: Math.random()*6 });
        }
    }

    function jump() {
        if (!isPlaying || isGameOver || isClashing) return;
        if (startFreeze > 0) startFreeze = 0;
        player.velocity = CONFIG.jumpStrength;
        createParticle(player.x, player.y + player.height, 'jump');
        if (frames % 10 === 0) AudioSys.playSound('jump');
    }

    function startGame() {
        if (isPlaying || isClashing) return; 

        if (AudioSys) {
            AudioSys.init();
            if (AudioSys.ctx && AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();
            AudioSys.playTrack('main');
            AudioSys.tempo = 1.45;
        }

        // UI Reset
        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('game-over-screen').classList.remove('active');
        document.getElementById('main-title').classList.add('hidden');
        document.getElementById('start-rev-img').style.display = 'none';
        document.getElementById('start-goose-img').style.display = 'none';
        document.getElementById('game-stage').classList.remove('blueprint-mode');
        
        // Game State Reset
        player.baseX = canvas.width * 0.30; 
        player.x = player.baseX; player.y = canvas.height / 2;
        player.velocity = 0; player.rotation = 0;
        
        goose.x = -150; goose.targetX = 150;
        obstacles = []; particles = []; coins = []; scoreFloater = []; bgElements = [];
        score = 0;
        document.getElementById('score-display').innerText = `Score: ${score}`;
        
        frames = 1; 
        CONFIG.gameSpeed = 3.5; 
        secretMode.active = false; battery.active = false;
        
        startFreeze = 60;   
        createObstacle(canvas.width); // Perfect start gap
        
        isGameOver = false; isClashing = false; isPlaying = true; isPaused = false;
        loop();
    }

    function update() {
        frames++; doodleTime += CONFIG.doodleWobbleSpeed;
        AudioSys.update();

        // 1. Clash Logic
        if (isClashing) {
            clashTimer--;
            player.rotation = Math.sin(frames*0.1)*0.1;
            if (clashTimer <= 0) {
                trySaveScore(score);
                AudioSys.stopMusic();
                isGameOver = true; isClashing = false;
                document.getElementById('final-score').innerText = score;
                document.getElementById('game-over-screen').classList.add('active');
            }
            return;
        }

        // 2. Physics
        if (startFreeze > 0) { startFreeze--; player.velocity = 0; } 
        else { player.velocity += CONFIG.gravity; }
        player.y += player.velocity;
        
        // Floor/Ceiling
        if (player.y + player.height > canvas.height || player.y < 0) {
            if (!secretMode.active) {
                AudioSys.playTrack('clash'); isPlaying = false; isClashing = true; clashTimer = CONFIG.clashDuration;
            }
        }

        // 3. Obstacles
        if (frames % CONFIG.spawnRate === 0) createObstacle();
        for (let i = obstacles.length - 1; i >= 0; i--) {
            let obs = obstacles[i];
            obs.x -= CONFIG.gameSpeed;
            // Collision
            if (player.x+10 < obs.x+obs.width && player.x+player.width-10 > obs.x && 
               (player.y+10 < obs.topHeight || player.y+player.height-10 > obs.bottomY)) {
                if (!secretMode.active) {
                    AudioSys.playTrack('clash'); isPlaying = false; isClashing = true; clashTimer = CONFIG.clashDuration;
                }
            }
            // Score
            if (obs.x + obs.width < player.x && !obs.passed) {
                score++; obs.passed = true;
                AudioSys.playTone(1200, 0.1, 'sine', 0.6);
                document.getElementById('score-display').innerText = `Score: ${score}`;
                if (!secretMode.active && score % 5 === 0) CONFIG.gameSpeed += 0.2;
            }
            if (obs.x < -100) obstacles.splice(i, 1);
        }
        
        // 4. Coins
        for (let i = coins.length - 1; i >= 0; i--) {
            let c = coins[i]; c.x -= CONFIG.gameSpeed;
            let dx = (player.x+25)-c.x, dy = (player.y+25)-c.y;
            if (Math.sqrt(dx*dx+dy*dy) < c.radius+25) {
                score+=c.value; AudioSys.playSound('coin');
                scoreFloater.push({x:c.x, y:c.y, text:"+"+c.value, life:60, vy:-2, color:c.color});
                coins.splice(i, 1);
            }
        }
        
        // 5. Visuals Update
        scoreFloater.forEach(f => { f.y+=f.vy; f.life--; });
        particles.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.life--; });
        goose.x += (goose.targetX - goose.x) * 0.05;
        goose.y += ((player.y - goose.y) * 0.02);
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Background (Simple Paper Grid)
        ctx.beginPath(); ctx.strokeStyle = "rgba(173, 216, 230, 0.5)";
        for (let x=0; x<canvas.width; x+=40) { ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); }
        for (let y=0; y<canvas.height; y+=40) { ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); }
        ctx.stroke(); ctx.beginPath(); ctx.strokeStyle = "rgba(255, 182, 193, 0.8)"; ctx.lineWidth = 2;
        ctx.moveTo(60, 0); ctx.lineTo(60, canvas.height); ctx.stroke();

        // Obstacles
        obstacles.forEach(obs => {
            ctx.fillStyle = ["#ffcc80", "#a5d6a7", "#90caf9"][obs.colorIndex];
            ctx.fillRect(obs.x, 0, obs.width, obs.topHeight);
            ctx.strokeRect(obs.x, 0, obs.width, obs.topHeight);
            ctx.fillRect(obs.x, obs.bottomY, obs.width, canvas.height-obs.bottomY);
            ctx.strokeRect(obs.x, obs.bottomY, obs.width, canvas.height-obs.bottomY);
        });

        // Coins & Floaters
        coins.forEach(c => { ctx.fillStyle=c.color; ctx.beginPath(); ctx.arc(c.x, c.y, c.radius, 0, Math.PI*2); ctx.fill(); ctx.stroke(); });
        scoreFloater.forEach(f => { ctx.fillStyle=f.color; ctx.font="24px sans-serif"; ctx.fillText(f.text, f.x, f.y); });

        // Player
        if (playerImg.complete && playerImg.naturalWidth > 0) {
            ctx.save(); ctx.translate(player.x+25, player.y+25); ctx.rotate(player.rotation);
            ctx.drawImage(playerImg, -37, -37, 75, 75); ctx.restore();
        } else {
            ctx.fillStyle = "blue"; ctx.fillRect(player.x, player.y, 50, 50);
        }
    }

    function loop() {
        if (!isPaused) {
            if (isPlaying || isClashing) { update(); draw(); }
            else if (isGameOver) draw();
        }
        requestAnimationFrame(loop);
    }

    // --- EVENTS ---
    document.getElementById('start-btn').addEventListener('click', startGame);
    document.getElementById('restart-btn').addEventListener('click', startGame);
    window.addEventListener('resize', resize);
    window.addEventListener('keydown', (e) => { 
        if (e.code === 'Space' || e.code === 'ArrowUp') { 
            if(isPaused) togglePause(); else jump(); 
        }
        if (e.code === 'Tab') { e.preventDefault(); togglePause(); }
    });
    canvas.addEventListener('mousedown', jump);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); }, { passive: false });
    
    function togglePause() {
        if (!isPlaying || isGameOver || isClashing) return;
        isPaused = !isPaused;
        const overlay = document.getElementById('pause-overlay');
        isPaused ? overlay.classList.add('active') : overlay.classList.remove('active');
        if(!isPaused && AudioSys.ctx && AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();
    }
    
    // Tap to resume
    document.getElementById('pause-overlay').addEventListener('click', togglePause);

    // --- ON LOAD ---
    window.onload = function() {
        resize();
        document.getElementById('loading').style.display = 'none';
        updateUserDisplay();
        
        // Audio controls listeners
        const vs = document.getElementById('volume-slider');
        if(vs) vs.addEventListener('input', (e) => { e.stopPropagation(); AudioSys.setVolume(e.target.value); if(AudioSys.ctx.state==='suspended')AudioSys.ctx.resume(); });
        
        // Start screen music
        window.addEventListener('click', function ms() {
            if(AudioSys.ctx && AudioSys.ctx.state==='suspended') AudioSys.ctx.resume();
            if(!AudioSys.isPlaying) AudioSys.playTrack('start_screen');
            window.removeEventListener('click', ms);
        }, {once:true});
    };

</script>
</body>
</html>


















































































